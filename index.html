<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Калькулятор сметы</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  input, select { width: 100%; box-sizing: border-box; }
  button { margin-top: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
</style>
</head>
<body>

<h1>Калькулятор сметы</h1>

<table id="estimateTable">
  <thead>
    <tr>
      <th>Категория</th>
      <th>Подкатегория</th>
      <th>Название работы</th>
      <th>Ед. изм</th>
      <th>Объем</th>
      <th>Сложность</th>
      <th>Цена за ед.</th>
      <th>Итог</th>
      <th>Действие</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="addRow()">Добавить работу</button>

<script>
// Пример справочника
const catalog = [
  {category:"Отделка", sub:"Покраска", name:"Покраска стен", unit:"м2", ranges:[{min:10,max:40,price:3000},{min:41,max:60,price:2500}]},
  {category:"Отделка", sub:"Покраска", name:"Покраска потолка", unit:"м2", ranges:[{min:5,max:20,price:4000},{min:21,max:50,price:3500}]},
];

// Сложности
const difficulties = { "Стандарт":1, "Выше среднего":1.2, "Сложно":1.5 };

function addRow() {
  const tbody = document.querySelector("#estimateTable tbody");
  const row = tbody.insertRow();
  
  row.innerHTML = `
    <td><input type="text" placeholder="Категория"></td>
    <td><input type="text" placeholder="Подкатегория"></td>
    <td>
      <select onchange="recalcRow(this)">
        <option value="">Выберите работу</option>
        ${catalog.map(c=>`<option value="${c.name}">${c.name}</option>`).join('')}
      </select>
    </td>
    <td><input type="text" readonly></td>
    <td><input type="number" value="0" oninput="recalcRow(this)"></td>
    <td>
      <select onchange="recalcRow(this)">
        ${Object.keys(difficulties).map(d=>`<option>${d}</option>`).join('')}
      </select>
    </td>
    <td><input type="number" readonly></td>
    <td><input type="number" readonly></td>
    <td><button onclick="deleteRow(this)">X</button></td>
  `;
}

function recalcRow(el) {
  const row = el.closest("tr");
  const workName = row.cells[2].querySelector("select").value;
  const volume = parseFloat(row.cells[4].querySelector("input").value) || 0;
  const difficulty = row.cells[5].querySelector("select").value;

  const work = catalog.find(w=>w.name===workName);
  if(work) {
    row.cells[0].querySelector("input").value = work.category;
    row.cells[1].querySelector("input").value = work.sub;
    row.cells[3].querySelector("input").value = work.unit;

    // Найти цену по диапазону
    let pricePerUnit = 0;
    for(let r of work.ranges){
      if(volume >= r.min && volume <= r.max){
        pricePerUnit = r.price * (difficulties[difficulty] || 1);
        break;
      }
    }

    row.cells[6].querySelector("input").value = pricePerUnit.toFixed(2);
    row.cells[7].querySelector("input").value = (pricePerUnit*volume).toFixed(2);
  } else {
    row.cells[6].querySelector("input").value = "";
    row.cells[7].querySelector("input").value = "";
  }
}

function deleteRow(btn){
  const row = btn.closest("tr");
  row.remove();
}

// Добавим первую пустую строку сразу
addRow();

</script>

</body>
</html>
